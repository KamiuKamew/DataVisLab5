<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数据可视化项目</title>
  <!-- 引入 D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    svg {
      width: 100%;
      height: auto;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: auto auto auto;
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }

    .tooltip {
      position: absolute;
      padding: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000; /* 确保 Tooltip 在最上层 */
    }

    /* 其他样式文件的引入 */
  </style>
  <link rel="stylesheet" href="./css/left_side_panel.css" />
  <link rel="stylesheet" href="./css/right_side_panel.css" />
  <link rel="stylesheet" href="./css/top_side_panel.css" />
</head>

<body>
  <!-- 地图容器 -->
  <svg viewBox="0 0 975 610" style="max-width: 100%; height: auto;"></svg>

  <!-- 左侧工具栏 -->
  <div class="dockPanelParent">
    <div class="left-toolbar">
      <button class="tabButton" id="btn-intro">介绍</button>
      <button class="tabButton" id="btn-filter">过滤器</button>
      <button class="tabButton" id="btn-params">参数</button>
    </div>
  </div>

  <!-- 第二层侧边栏 -->
  <div id="sidePanel" class="sidePanel hidden">
    <h2 id="sidePanelTitle">介绍</h2>
    <div class="content" id="sidePanelContent">
      <p>这是介绍内容。</p>
    </div>
    <!-- 拖拽控件的父容器 -->
    <div class="draggerParentHorizontal" id="draggerParent">
      <div class="splitPaneDragger" id="splitPaneDragger"></div>
    </div>
  </div>

  <!-- 顶部工具栏 -->
  <div class="top-toolbar">
    <button class="top-button" id="btn-map-view">地图视图</button>
    <button class="top-button" id="btn-distance-view">距离拓扑</button>
    <button class="top-button" id="btn-time-view">时间拓扑</button>
  </div>

  <!-- 右侧工具栏 -->
  <!-- 按钮容器 -->
  <div class="button-container">
    <div class="sidebar-button sidebar-group-1" id="sidebarButton1"></div>
    <div class="sidebar-button sidebar-group-2" id="sidebarButton2"></div>
    <div class="sidebar-button sidebar-group-3" id="sidebarButton3"></div>
    <div class="sidebar-button sidebar-group-4" id="sidebarButton4"></div>
  </div>

  <!-- 侧边栏内容 -->
  <div class="sidebars-container">
    <div class="sidebar sidebar-group-1" id="sidebar1">
      <div class="dragger" id="dragger1"></div>
      <div class="sidebar-content">
        <svg id="densityChart" style="width: 100%; height: 400px;"></svg>
      </div>
    </div>

    <div class="sidebar sidebar-group-2" id="sidebar2">
      <div class="dragger" id="dragger2"></div>
      <div class="sidebar-content">
        <svg id="heatMap" style="width: 100%; height: 400px;"></svg>
      </div>
    </div>

    <div class="sidebar sidebar-group-3" id="sidebar3">
      <div class="dragger" id="dragger3"></div>
      <div class="sidebar-content">
        <img src="https://via.placeholder.com/150/ff5722" alt="Image" style="width: 100%; height: auto" />
      </div>
    </div>

    <div class="sidebar sidebar-group-4" id="sidebar4">
      <div class="dragger" id="dragger4"></div>
      <div class="sidebar-content">
        <table border="1" width="100%">
          <tr>
            <th>产品</th>
            <th>价格</th>
          </tr>
          <tr>
            <td>产品A</td>
            <td>￥100</td>
          </tr>
          <tr>
            <td>产品B</td>
            <td>￥200</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- 添加图表容器 -->
  <div class="dashboard">
    <div class="chart-container" id="scatter-matrix"></div>
    <!-- 如果有其他图表，可以继续添加对应的容器 -->
  </div>

  <!-- 引入 TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3.0.0/dist/topojson-client.min.js"></script>

  <script src="./Context.ts" type="module"></script>

  <script>
    // 数据生成函数
    function generateData() {
      const cities = ['北京', '上海', '广州', '深圳', '成都', '重庆', '武汉', '西安', '南京', '杭州'];
      const trainTypes = ['高铁', '动车', '普快', '特快'];
      const routes = [];

      // 生成路线数据
      for (let i = 0; i < cities.length; i++) {
        for (let j = i + 1; j < cities.length; j++) {
          const distance = Math.round(300 + Math.random() * 1500);
          const baseTime = distance / 250; // 基础时间（小时）

          trainTypes.forEach(type => {
            const speedFactor = type === '高铁' ? 1 :
              type === '动车' ? 1.2 :
                type === '特快' ? 1.8 : 2.2;

            routes.push({
              from: cities[i],
              to: cities[j],
              distance: distance,
              type: type,
              time: Math.round(baseTime * speedFactor * 10) / 10,
              price: Math.round((distance * (type === '高铁' ? 0.45 :
                type === '动车' ? 0.35 :
                  type === '特快' ? 0.25 : 0.15)) * 10) / 10,
              frequency: Math.round(type === '高铁' ? 20 + Math.random() * 30 :
                type === '动车' ? 15 + Math.random() * 25 :
                  type === '特快' ? 5 + Math.random() * 15 :
                    3 + Math.random() * 10),
              passengers: Math.round(1000 + Math.random() * 5000)
            });
          });
        }
      }

      // 生成时间序列数据
      const timeSeriesData = [];
      const now = new Date();
      for (let i = 0; i < 365; i++) {
        const date = new Date(now.getTime() - (365 - i) * 24 * 60 * 60 * 1000);
        timeSeriesData.push({
          date: date,
          passengers: Math.round(50000 + Math.random() * 30000 +
            Math.sin(i / 30) * 10000 + // 季节性波动
            (i % 7 < 5 ? 5000 : 15000)), // 周末效应
          trains: Math.round(800 + Math.random() * 200 +
            Math.sin(i / 30) * 50 +
            (i % 7 < 5 ? 50 : 100))
        });
      }

      return {
        routes: routes,
        timeSeries: timeSeriesData
      };
    }

    // 生成数据
    const data = generateData();
    const tooltip = d3.select("body")
      .append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    // 创建散点矩阵图函数
    function createScatterMatrix() {
      const container = d3.select("#scatter-matrix");
      container.append("div")
        .attr("class", "chart-title")
        .text("路线分析矩阵");

      const margin = { top: 20, right: 20, bottom: 40, left: 50 };
      const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
      const height = 400 - margin.top - margin.bottom;

      const svg = container.append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // 比例尺
      const xScale = d3.scaleLinear()
        .domain([0, d3.max(data.routes, d => d.distance)])
        .range([0, width]);

      const yScale = d3.scaleLinear()
        .domain([0, d3.max(data.routes, d => d.time)])
        .range([height, 0]);

      const rScale = d3.scaleSqrt()
        .domain([0, d3.max(data.routes, d => d.passengers)])
        .range([3, 20]);

      const colorScale = d3.scaleOrdinal()
        .domain(['高铁', '动车', '普快', '特快'])
        .range(['#ff7675', '#74b9ff', '#55efc4', '#ffeaa7']);

      // 坐标轴
      const xAxis = d3.axisBottom(xScale);
      const yAxis = d3.axisLeft(yScale);

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(xAxis);

      svg.append("g")
        .call(yAxis);

      // 添加标签
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height + 35)
        .style("text-anchor", "middle")
        .text("距离 (km)");

      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", -40)
        .style("text-anchor", "middle")
        .text("时间 (小时)");

      // 绘制气泡
      svg.selectAll("circle")
        .data(data.routes)
        .join("circle")
        .attr("cx", d => xScale(d.distance))
        .attr("cy", d => yScale(d.time))
        .attr("r", d => rScale(d.passengers))
        .attr("fill", d => colorScale(d.type))
        .attr("opacity", 0.7)
        .on("mouseover", function (event, d) {
          d3.select(this).attr("opacity", 1);
          tooltip.transition()
            .duration(200)
            .style("opacity", .9);
          tooltip.html(`${d.from} - ${d.to}<br/>
                      类型: ${d.type}<br/>
                      距离: ${d.distance}km<br/>
                      时间: ${d.time}小时<br/>
                      客流量: ${d.passengers}人`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function () {
          d3.select(this).attr("opacity", 0.7);
          tooltip.transition()
            .duration(500)
            .style("opacity", 0);
        });

      // 添加图例
      const legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", `translate(${width - 100}, 0)`);

      const trainTypes = ['高铁', '动车', '普快', '特快'];
      trainTypes.forEach((type, i) => {
        const legendRow = legend.append("g")
          .attr("transform", `translate(0, ${i * 20})`);

        legendRow.append("circle")
          .attr("cx", 0)
          .attr("cy", 0)
          .attr("r", 6)
          .attr("fill", colorScale(type));

        legendRow.append("text")
          .attr("x", 10)
          .attr("y", 4)
          .style("font-size", "12px")
          .text(type);
      });
    }

    // 主函数：初始化所有图表并添加响应式支持
    function initializeVisualization() {
      // 初始化所有图表
      createScatterMatrix();
      // 如果有其他图表函数，可以在此调用

      // 添加窗口大小改变时的响应式处理
      let resizeTimeout;
      window.addEventListener('resize', function () {
        // 使用防抖处理resize事件
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function () {
          // 清除所有现有图表
          d3.selectAll(".dashboard .chart-container").selectAll("svg").remove();
          d3.selectAll(".dashboard .chart-container").selectAll(".chart-title").remove();

          // 重新初始化所有图表
          createScatterMatrix();
          // 如果有其他图表函数，可以在此调用
        }, 250);
      });

      // 添加图表切换按钮
      const buttonContainer = d3.select("body") // 确保有一个容器，或添加一个
        .append("div")
        .attr("id", "visualization-controls")
        .attr("class", "flex justify-center space-x-4 my-4");

      const charts = [
        { id: "scatter-matrix", name: "散点矩阵" },
        // 如果有其他图表，添加相应的 id 和 name
        // { id: "parallel-coords", name: "平行坐标" },
        // { id: "stacked-area", name: "趋势分析" },
        // { id: "boxplot", name: "统计分布" },
        // { id: "calendar-heatmap", name: "日历热力" }
      ];

      charts.forEach((chart, index) => {
        buttonContainer.append("button")
          .attr("class", `px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 ${index === 0 ? 'bg-blue-700 text-white' : 'bg-blue-500 text-white hover:bg-blue-600'}`)
          .text(chart.name)
          .on("click", function () {
            // 隐藏所有图表
            charts.forEach(c => {
              d3.select(`#${c.id}`).style("display", "none");
            });
            // 显示选中的图表
            d3.select(`#${chart.id}`).style("display", "block");
            // 如果图表尚未初始化，则初始化它
            const svgExists = d3.select(`#${chart.id}`).select("svg").empty();
            if (svgExists) {
              createScatterMatrix(); // 根据 chart.id 调用相应的函数
            }
            // 更新按钮样式
            buttonContainer.selectAll("button")
              .classed("bg-blue-700 text-white", false)
              .classed("bg-blue-500 text-white hover:bg-blue-600", true);
            d3.select(this)
              .classed("bg-blue-700 text-white", true)
              .classed("bg-blue-500 text-white hover:bg-blue-600", false);
          });
      });

      // 默认显示第一个图表
      d3.select("#scatter-matrix").style("display", "block");
    }

    // 添加数据下载功能
    function addDataDownload() {
      const downloadContainer = d3.select("body") // 确保有一个容器，或添加一个
        .append("div")
        .attr("id", "data-download")
        .attr("class", "flex justify-center space-x-4 my-4");

      // 添加路线数据下载按钮
      downloadContainer.append("button")
        .attr("class", "px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50")
        .text("下载路线数据")
        .on("click", () => {
          const csv = d3.csvFormat(data.routes);
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', 'railway_routes.csv');
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

      // 添加时间序列数据下载按钮
      downloadContainer.append("button")
        .attr("class", "px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50")
        .text("下载时间序列数据")
        .on("click", () => {
          const csv = d3.csvFormat(data.timeSeries.map(d => ({
            date: d3.timeFormat("%Y-%m-%d")(d.date),
            passengers: d.passengers,
            trains: d.trains
          })));
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', 'railway_timeseries.csv');
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
    }

    // 添加图表说明
    function addChartDescriptions() {
      const descriptions = {
        "scatter-matrix": "散点矩阵图展示了不同列车类型的距离-时间关系，气泡大小表示客流量。",
        // 如果有其他图表，添加相应的说明
      };

      Object.entries(descriptions).forEach(([id, desc]) => {
        d3.select(`#${id}`)
          .append("div")
          .attr("class", "text-sm text-gray-600 mt-2 text-center")
          .text(desc);
      });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      initializeVisualization();
      addDataDownload();
      addChartDescriptions();
    });
  </script>

</body>

</html>
